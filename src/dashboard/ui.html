<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QClaw Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öõ</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#08080d;--bg-1:#0e0e16;--bg-2:#16161f;--bg-3:#1e1e2a;--bg-hover:#1a1a28;
      --border:#252535;--border-l:#353548;--text:#e4e4ef;--text-dim:#6b6b8a;--text-xs:#4a4a66;
      --accent:#8b5cf6;--accent-l:#a78bfa;--accent-bg:#8b5cf620;
      --green:#22c55e;--green-bg:#22c55e18;--red:#ef4444;--red-bg:#ef444418;
      --yellow:#eab308;--yellow-bg:#eab30818;--blue:#3b82f6;--blue-bg:#3b82f618;--cyan:#06b6d4;
      --sidebar-w:56px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;display:flex;height:100vh;overflow:hidden;font-size:14px}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
    .sidebar{width:var(--sidebar-w);background:var(--bg-1);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;z-index:20}
    .sidebar-logo{padding:14px 0;text-align:center;border-bottom:1px solid var(--border);font-size:1.3rem;cursor:default}
    .nav-item{display:flex;align-items:center;justify-content:center;padding:12px 0;cursor:pointer;color:var(--text-dim);transition:all .15s;position:relative;font-size:1.1rem}
    .nav-item:hover{color:var(--text);background:var(--bg-hover)}
    .nav-item.active{color:var(--accent-l);background:var(--accent-bg)}
    .nav-item.active::before{content:'';position:absolute;left:0;top:8px;bottom:8px;width:2px;background:var(--accent);border-radius:0 2px 2px 0}
    .nav-item .tip{display:none;position:absolute;left:calc(var(--sidebar-w) + 8px);top:50%;transform:translateY(-50%);background:var(--bg-3);border:1px solid var(--border-l);padding:4px 10px;border-radius:6px;font-size:.75rem;white-space:nowrap;z-index:30;font-family:Outfit}
    .nav-item:hover .tip{display:block}
    .nav-sep{height:1px;background:var(--border);margin:4px 12px}
    .nav-bottom{margin-top:auto}
    .dot-sm{width:7px;height:7px;border-radius:50%;position:absolute;bottom:8px;right:14px}
    .dot-sm.on{background:var(--green);box-shadow:0 0 4px var(--green)}.dot-sm.off{background:var(--red)}
    .main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
    .topbar{height:48px;background:var(--bg-1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0}
    .topbar-title{font-weight:600;font-size:.9rem}
    .topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}
    .badge{font-size:.65rem;padding:2px 8px;border-radius:10px;font-weight:500}
    .badge-green{background:var(--green-bg);color:var(--green)}.badge-red{background:var(--red-bg);color:var(--red)}.badge-yellow{background:var(--yellow-bg);color:var(--yellow)}.badge-accent{background:var(--accent-bg);color:var(--accent-l)}
    .page{display:none;flex:1;overflow:hidden}.page.active{display:flex;flex-direction:column}
    .chat-layout{display:flex;flex:1;overflow:hidden}
    .thread-list{width:240px;background:var(--bg-1);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}
.thread-list-header{padding:12px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:4px}
.thread-agent-label{font-size:.7rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.05em}
.thread-list-header select{width:100%;background:var(--bg-2);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:6px;font-family:Outfit;font-size:.8rem;outline:none}
    .thread-items{flex:1;overflow-y:auto}
    .thread-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .1s}
    .thread-item:hover{background:var(--bg-hover)}.thread-item.active{background:var(--accent-bg);border-left:2px solid var(--accent)}
    .thread-item-name{font-size:.82rem;font-weight:500;margin-bottom:2px;display:flex;align-items:center;gap:6px}
    .thread-item-meta{font-size:.7rem;color:var(--text-dim);display:flex;justify-content:space-between}
    .new-chat-btn{margin:8px;padding:8px;background:var(--accent-bg);border:1px solid #8b5cf644;border-radius:8px;color:var(--accent-l);cursor:pointer;text-align:center;font-size:.8rem;font-weight:500;transition:all .15s}
    .new-chat-btn:hover{background:var(--accent);color:#fff}
    .chat-pane{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .chat-messages{flex:1;overflow-y:auto;padding:16px}
    .msg{margin-bottom:12px;max-width:75%}.msg.user{margin-left:auto}
    .msg-header{font-size:.65rem;color:var(--text-dim);margin-bottom:3px;display:flex;align-items:center;gap:6px}
    .msg-bubble{padding:10px 14px;border-radius:12px;font-size:.85rem;line-height:1.6;word-break:break-word}
    .msg-bubble p{margin:0 0 8px 0}.msg-bubble p:last-child{margin:0}
    .msg-bubble code{background:var(--bg-3);padding:1px 5px;border-radius:3px;font-family:'JetBrains Mono';font-size:.78rem}
    .msg-bubble pre{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin:8px 0;overflow-x:auto;position:relative}
    .msg-bubble pre code{background:none;padding:0;font-size:.75rem;line-height:1.5}
    .msg-bubble ul,.msg-bubble ol{margin:4px 0 8px 16px}.msg-bubble li{margin:2px 0}
    .msg-bubble strong{color:var(--text)}
    .msg-bubble a{color:var(--accent-l);text-decoration:none}.msg-bubble a:hover{text-decoration:underline}
    .msg-bubble img{max-width:100%;border-radius:8px;margin:6px 0}
    .msg.user .msg-bubble{background:var(--accent-bg);border:1px solid #8b5cf633;border-bottom-right-radius:4px}
    .msg.assistant .msg-bubble{background:var(--bg-2);border:1px solid var(--border);border-bottom-left-radius:4px}
    .msg-meta{font-size:.6rem;color:var(--text-xs);margin-top:3px}
    .msg-images{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
    .msg-images img{max-width:200px;max-height:150px;border-radius:8px;object-fit:cover;border:1px solid var(--border)}
    .copy-btn{position:absolute;top:6px;right:6px;background:var(--bg-3);border:1px solid var(--border);color:var(--text-dim);padding:2px 8px;border-radius:4px;cursor:pointer;font-size:.65rem;font-family:Outfit;opacity:0;transition:opacity .15s}
    pre:hover .copy-btn{opacity:1}.copy-btn:hover{color:var(--text);background:var(--accent)}
    #typing{display:none;padding:0 16px 8px;color:var(--text-dim);font-size:.8rem;font-style:italic}
    .chat-input-area{border-top:1px solid var(--border);background:var(--bg-1);padding:8px 16px 12px}
    .image-preview{display:flex;gap:6px;flex-wrap:wrap;padding:0 0 8px}
    .image-preview-item{position:relative;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
    .image-preview-item img{width:60px;height:60px;object-fit:cover;display:block}
    .image-preview-item .remove{position:absolute;top:2px;right:2px;background:var(--red);color:#fff;border:none;width:16px;height:16px;border-radius:50%;cursor:pointer;font-size:10px;line-height:16px;text-align:center;padding:0}
    .chat-input-row{display:flex;gap:8px;align-items:flex-end}
    .chat-input-row textarea{flex:1;padding:10px 14px;background:var(--bg-2);border:1px solid var(--border);color:var(--text);border-radius:10px;outline:none;font-family:Outfit;font-size:.85rem;resize:none;min-height:40px;max-height:120px;line-height:1.4}
    .chat-input-row textarea:focus{border-color:var(--accent)}
    .chat-btns{display:flex;gap:4px}
    .chat-btn{padding:8px 12px;background:var(--bg-3);border:1px solid var(--border);color:var(--text-dim);border-radius:10px;cursor:pointer;font-size:.9rem;transition:all .15s;line-height:1}
    .chat-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .chat-btn.send{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:600;font-family:Outfit;font-size:.85rem;padding:8px 18px}
.chat-btn.send:disabled{opacity:0.6;cursor:not-allowed}
    .drop-overlay{display:none;position:absolute;inset:0;background:var(--accent-bg);border:2px dashed var(--accent);border-radius:12px;z-index:10;align-items:center;justify-content:center;font-size:1.1rem;color:var(--accent-l);font-weight:500}
    .empty-chat{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;color:var(--text-dim);gap:8px}
    .empty-chat span:first-child{font-size:2rem}
.loading-spinner{display:inline-block;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
    .page-scroll{flex:1;overflow-y:auto;padding:20px}
    .section-title{font-size:.95rem;font-weight:600;margin-bottom:12px}
    .section-sub{font-size:.75rem;color:var(--text-dim);margin-bottom:16px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:24px}
    .card{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:16px}
    .card-label{font-size:.7rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
    .card-value{font-size:1.4rem;font-weight:600;font-family:'JetBrains Mono'}
    .card-sub{font-size:.72rem;color:var(--text-dim);margin-top:4px}
    .table-wrap{overflow-x:auto;margin-bottom:24px}
    table{width:100%;border-collapse:collapse;font-size:.82rem}
    th{text-align:left;padding:8px 12px;color:var(--text-dim);font-weight:500;font-size:.7rem;text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--border)}
    td{padding:8px 12px;border-bottom:1px solid var(--border)}
    tr:hover td{background:var(--bg-hover)}
    .config-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}
    .config-key{font-family:'JetBrains Mono';font-size:.78rem;color:var(--accent-l);min-width:200px}
    .config-val{flex:1}.config-val input{width:100%;background:var(--bg-2);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:4px;font-family:'JetBrains Mono';font-size:.78rem;outline:none}
    .config-val input:focus{border-color:var(--accent)}
    .btn-sm{padding:3px 10px;background:var(--bg-3);border:1px solid var(--border);color:var(--text-dim);border-radius:4px;cursor:pointer;font-size:.7rem;font-family:Outfit;transition:all .15s}
    .btn-sm:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .log-viewer{background:var(--bg-2);border:1px solid var(--border);border-radius:8px;padding:12px;font-family:'JetBrains Mono';font-size:.72rem;overflow-y:auto;max-height:calc(100vh - 200px);line-height:1.6}
    .log-line{padding:1px 0}.log-line.error{color:var(--red)}.log-line.warn{color:var(--yellow)}.log-line.info{color:var(--text-dim)}
    .usage-bar-wrap{margin-bottom:12px}
    .usage-bar-label{display:flex;justify-content:space-between;font-size:.75rem;margin-bottom:4px}
    .usage-bar{height:6px;background:var(--bg-3);border-radius:3px;overflow:hidden}
    .usage-bar-fill{height:100%;border-radius:3px;transition:width .5s}
    .pairing-banner{background:var(--yellow-bg);border:1px solid #eab30833;border-radius:8px;padding:12px 16px;margin-bottom:16px;display:none}
    .pairing-banner-title{font-size:.8rem;font-weight:600;color:var(--yellow);margin-bottom:6px}
    .pairing-item{display:flex;align-items:center;justify-content:space-between;padding:4px 0;font-size:.8rem}
    .pairing-item button{padding:4px 12px;background:var(--green);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:.75rem}
    @media(max-width:768px){.sidebar{width:48px}.thread-list{width:180px}.msg{max-width:90%}.cards{grid-template-columns:1fr 1fr}.config-key{min-width:120px}}
    @media(max-width:480px){.thread-list{display:none}.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <nav class="sidebar" role="navigation" aria-label="Dashboard">
    <div class="sidebar-logo" aria-hidden="true">‚öõ</div>
    <div class="nav-item active" data-page="chat" role="button" tabindex="0" aria-label="Chat">üí¨<span class="tip">Chat</span></div>
    <div class="nav-item" data-page="overview" role="button" tabindex="0" aria-label="Overview">üìä<span class="tip">Overview</span></div>
    <div class="nav-item" data-page="channels" role="button" tabindex="0" aria-label="Channels">üì°<span class="tip">Channels</span></div>
    <div class="nav-item" data-page="usage" role="button" tabindex="0" aria-label="Usage">üìà<span class="tip">Usage</span></div>
    <div class="nav-sep"></div>
    <div class="nav-item" data-page="agents" role="button" tabindex="0" aria-label="Agents">ü§ñ<span class="tip">Agents</span></div>
    <div class="nav-item" data-page="skills" role="button" tabindex="0" aria-label="Skills">üîß<span class="tip">Skills</span></div>
    <div class="nav-item" data-page="memory" role="button" tabindex="0" aria-label="Memory">üß†<span class="tip">Memory</span></div>
    <div class="nav-sep"></div>
    <div class="nav-item" data-page="config" role="button" tabindex="0" aria-label="Config">‚öôÔ∏è<span class="tip">Config</span></div>
    <div class="nav-item" data-page="logs" role="button" tabindex="0" aria-label="Logs">üìã<span class="tip">Logs</span></div>
    <div class="nav-bottom"><div class="nav-sep"></div><div class="nav-item" style="position:relative" role="status" aria-live="polite" aria-label="Connection status" id="nav-ws"><span aria-hidden="true">‚ö°</span><span class="tip" id="ws-tip">Connecting...</span><span class="dot-sm off" id="ws-dot"></span></div></div>
  </nav>
  <div class="main">
    <div class="topbar">
      <span class="topbar-title" id="page-title">Chat</span>
      <div class="topbar-right">
        <button class="btn-sm" id="copy-url-btn" title="Copy dashboard URL (open on another device)" aria-label="Copy dashboard URL">Copy link</button>
        <span class="badge badge-accent" id="agent-badge">echo</span>
        <span class="badge" id="status-badge">‚óè Connecting</span>
      </div>
    </div>
    <div class="page active" id="page-chat">
      <div id="pairing-banner" class="pairing-banner" style="margin:12px 16px 0"><div class="pairing-banner-title">üîê Pending Pairing Requests</div><div id="pairing-list"></div></div>
      <div class="chat-layout">
        <div class="thread-list">
          <div class="thread-list-header"><label for="agent-select" class="thread-agent-label">Agent</label><select id="agent-select" aria-label="Choose agent"></select></div>
          <div class="thread-items" id="thread-items"></div>
          <div class="new-chat-btn" id="new-chat-btn">+ New Chat</div>
        </div>
        <div class="chat-pane" style="position:relative">
          <div class="drop-overlay" id="drop-overlay">üìé Drop image here</div>
          <div class="chat-messages" id="messages"><div class="empty-chat"><span>‚öõ</span><span>Type a message below to start, or pick a conversation from the list</span></div></div>
          <div id="typing">Agent is typing...</div>
          <div class="chat-input-area">
            <div class="image-preview" id="image-preview"></div>
            <div class="chat-input-row">
              <button class="chat-btn" id="upload-btn" title="Upload image" aria-label="Upload image">üìé</button>
              <textarea id="chat-input" placeholder="Type a message... (paste images with Ctrl+V)" rows="1" aria-label="Message"></textarea>
              <button class="chat-btn send" id="chat-send" aria-label="Send message" disabled title="Connecting...">Send</button>
            </div>
            <input type="file" id="file-input" accept="image/*" multiple style="display:none">
          </div>
        </div>
      </div>
    </div>
    <div class="page" id="page-overview"><div class="page-scroll"><div class="section-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">System Overview <button class="btn-sm" onclick="loadOverview()">Refresh</button></div><div class="cards" id="overview-cards"></div><div class="section-title">Quick Stats</div><div class="cards" id="overview-stats"></div></div></div>
    <div class="page" id="page-channels"><div class="page-scroll"><div class="section-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">Connected Channels <button class="btn-sm" onclick="loadChannels()">Refresh</button></div><div class="cards" id="channel-cards"></div><div class="section-title">Paired Users</div><div class="table-wrap"><table><thead><tr><th>Channel</th><th>User</th><th>Messages</th><th>Last Active</th></tr></thead><tbody id="paired-table"></tbody></table></div></div></div>
    <div class="page" id="page-usage"><div class="page-scroll"><div class="section-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">Cost & Usage <button class="btn-sm" onclick="loadUsage()">Refresh</button></div><div class="cards" id="usage-cards"></div><div class="section-title">By Channel</div><div id="usage-channels"></div><div class="section-title" style="margin-top:20px">Recent Activity</div><div class="table-wrap"><table><thead><tr><th>Time</th><th>Agent</th><th>Tier</th><th>Model</th><th>Cost</th></tr></thead><tbody id="usage-table"></tbody></table></div></div></div>
    <div class="page" id="page-agents"><div class="page-scroll"><div class="section-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">Registered Agents <button class="btn-sm" onclick="loadAgents()">Refresh</button></div><div class="section-sub">Each agent has its own personality (SOUL.md), skills, and conversation threads.</div><div class="cards" id="agent-cards"></div></div></div>
    <div class="page" id="page-skills"><div class="page-scroll"><div class="section-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">Installed Skills <button class="btn-sm" onclick="loadSkills()">Refresh</button></div><div class="table-wrap"><table><thead><tr><th>Name</th><th>Endpoints</th><th>Status</th><th>Source</th></tr></thead><tbody id="skills-table"></tbody></table></div></div></div>
    <div class="page" id="page-memory"><div class="page-scroll"><div class="section-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">Knowledge & Memory <button class="btn-sm" onclick="loadMemory()">Refresh</button></div><div class="cards" id="memory-cards"></div><div class="section-title">Search Memory</div><div style="display:flex;gap:8px;margin-bottom:16px"><input type="text" id="memory-query" placeholder="Search knowledge graph..." aria-label="Search memory" onkeydown="if(event.key==='Enter')searchMemory()" style="flex:1;padding:8px 12px;background:var(--bg-2);border:1px solid var(--border);color:var(--text);border-radius:8px;outline:none;font-family:Outfit;font-size:.85rem"><button onclick="searchMemory()" class="btn-sm" style="padding:8px 16px">Search</button></div><div id="memory-results" style="font-size:.82rem;color:var(--text-dim)"></div></div></div>
    <div class="page" id="page-config"><div class="page-scroll"><div class="section-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">Configuration <button class="btn-sm" onclick="loadConfig()">Refresh</button></div><div class="section-sub">Edit values and press Enter to save. Sensitive fields are masked.</div><div id="config-editor"></div></div></div>
    <div class="page" id="page-logs"><div class="page-scroll"><div class="section-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">Audit Log <span style="display:flex;gap:8px;align-items:center"><button class="btn-sm" id="logs-live-btn" onclick="toggleLogsLive()">Live (5s)</button><button class="btn-sm" onclick="loadLogs()">Refresh</button><button class="btn-sm" onclick="loadLogs('error')">Errors only</button></span></div><div class="log-viewer" id="log-viewer"></div></div></div>
  </div>
<script>
const hp=new URLSearchParams(location.hash.slice(1)),qp=new URLSearchParams(location.search);
let TOKEN=hp.get('token')||qp.get('token')||localStorage.getItem('qclaw_token')||'';
if(TOKEN){localStorage.setItem('qclaw_token',TOKEN);if(location.hash)history.replaceState(null,'',location.pathname)}
if(!TOKEN){document.querySelector('.sidebar').style.display='none';document.querySelector('.main').innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh"><div style="text-align:center;max-width:340px;padding:2rem"><div style="font-size:2rem;margin-bottom:1rem" aria-hidden="true">‚öõ</div><h2 style="font-size:1.1rem;margin-bottom:.5rem;font-weight:600">QClaw Dashboard</h2><p style="color:var(--text-dim);font-size:.82rem;margin-bottom:1.2rem">Enter your auth token.</p><p style="color:var(--text-xs);font-size:.75rem;margin-bottom:8px">Get your URL and token by running <code style="background:var(--bg-2);padding:2px 6px;border-radius:3px">qclaw dashboard</code> in a terminal.</p><input id="token-input" type="text" placeholder="Paste token" aria-label="Auth token" style="width:100%;padding:8px 12px;background:var(--bg-2);border:1px solid var(--border);color:var(--text);border-radius:8px;font-family:JetBrains Mono;font-size:.8rem;outline:none;margin-bottom:8px"><button onclick="submitToken()" style="width:100%;padding:8px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-family:Outfit">Connect</button></div></div>';document.getElementById('token-input')?.addEventListener('keydown',e=>{if(e.key==='Enter')submitToken()});document.getElementById('token-input')?.focus()}
function submitToken(){const t=document.getElementById('token-input').value.trim();if(t){localStorage.setItem('qclaw_token',t);location.reload()}}
async function checkPin(){if(!TOKEN)return;try{const r=await fetch('/api/auth/pin-required');const d=await r.json();if(!d.pinRequired)return;if(sessionStorage.getItem('qclaw_pin_ok')==='1')return;document.querySelector('.sidebar').style.display='none';document.querySelector('.main').innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh"><div style="text-align:center;max-width:300px;padding:2rem"><div style="font-size:2rem;margin-bottom:1rem">üîí</div><h2 style="font-size:1.1rem;margin-bottom:.5rem;font-weight:600">Enter PIN</h2><input id="pin-input" type="password" inputmode="numeric" maxlength="8" placeholder="PIN" style="width:100%;padding:10px;background:var(--bg-2);border:1px solid var(--border);color:var(--text);border-radius:8px;font-family:JetBrains Mono;font-size:1.3rem;text-align:center;outline:none;letter-spacing:.5rem;margin-bottom:8px"><button onclick="submitPin()" style="width:100%;padding:8px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-family:Outfit">Unlock</button><p id="pin-error" style="color:var(--red);font-size:.75rem;margin-top:8px;display:none"></p></div></div>';document.getElementById('pin-input').addEventListener('keydown',e=>{if(e.key==='Enter')submitPin()});document.getElementById('pin-input').focus()}catch{}}
async function submitPin(){const p=document.getElementById('pin-input').value.trim();if(!p)return;const r=await fetch('/api/auth/verify-pin',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+TOKEN},body:JSON.stringify({pin:p})});if(r.ok){sessionStorage.setItem('qclaw_pin_ok','1');location.reload()}else{const d=await r.json();const e=document.getElementById('pin-error');e.textContent=(d.attemptsLeft!=null?'Wrong PIN. '+d.attemptsLeft+' attempts left.':(d.error||'Wrong PIN'));e.style.display='block';document.getElementById('pin-input').value='';document.getElementById('pin-input').focus()}}
if(TOKEN)checkPin();

function copyDashboardUrl(){
  const url=location.origin+location.pathname+(location.search||'')+'#token='+TOKEN;
  navigator.clipboard.writeText(url).then(()=>{const b=document.getElementById('copy-url-btn');if(b){b.textContent='Copied!';setTimeout(()=>b.textContent='Copy link',2000)}}).catch(()=>{});
}
document.getElementById('copy-url-btn')?.addEventListener('click',copyDashboardUrl);

async function api(path,opts={}){const h={...(opts.headers||{}),'Authorization':'Bearer '+TOKEN};if(opts.body&&typeof opts.body==='object'){h['Content-Type']='application/json';opts.body=JSON.stringify(opts.body)}return fetch(path,{...opts,headers:h})}

let ws,wsRetry=0;
function connectWS(){
  ws=new WebSocket((location.protocol==='https:'?'wss:':'ws:')+'//'+location.host+'/ws'+(TOKEN?'?token='+TOKEN:''));
  ws.onopen=()=>{wsRetry=0;document.getElementById('ws-dot').className='dot-sm on';document.getElementById('ws-tip').textContent='Connected';document.getElementById('status-badge').className='badge badge-green';document.getElementById('status-badge').textContent='‚óè Online';document.getElementById('status-badge').title='';const sb=document.getElementById('chat-send');if(sb){sb.disabled=false;sb.title=''}loadPairings()};
  ws.onclose=()=>{document.getElementById('ws-dot').className='dot-sm off';document.getElementById('ws-tip').textContent='Reconnecting...';document.getElementById('status-badge').className='badge badge-red';document.getElementById('status-badge').textContent='‚óè Offline';document.getElementById('status-badge').title='Connection lost. Reconnecting...';const sb=document.getElementById('chat-send');if(sb){sb.disabled=true;sb.title='Connect to send messages'};if(wsRetry<50){setTimeout(connectWS,Math.min(1000*Math.pow(1.5,wsRetry),30000));wsRetry++}};
  ws.onerror=()=>{};
  ws.onmessage=(e)=>{const d=JSON.parse(e.data);if(d.type==='typing')document.getElementById('typing').style.display='block';else if(d.type==='response'){document.getElementById('typing').style.display='none';addMsg('assistant',d.content,d.model?d.tier+' ‚Üí '+d.model+' (¬£'+(d.cost||0).toFixed(4)+')':'reflex');const sb=document.getElementById('chat-send');if(sb)sb.disabled=!ws||ws.readyState!==1}else if(d.type==='error'){document.getElementById('typing').style.display='none';addMsg('assistant','Error: '+d.error);const sb=document.getElementById('chat-send');if(sb)sb.disabled=false}else if(d.type==='channel_message'){refreshThreads();if(currentThread?.channel===d.channel&&(currentThread?.username===d.username||!currentThread?.username)){addMsg('user',d.userMessage,'üì± '+d.channel+' @'+(d.username||'user'));addMsg('assistant',d.response,d.model?d.tier+' ‚Üí '+d.model+' (¬£'+(d.cost||0).toFixed(4)+')':'reflex')}highlightThread(d.channel,d.username)}};
}
if(TOKEN)connectWS();

let currentThread=null,currentAgent=null;
let pendingImages=[]; // [{data:base64, mediaType:'image/jpeg', preview:dataUrl}]

// Simple markdown renderer
function renderMd(text){
  if(!text)return'';
  let h=text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    // Code blocks
    .replace(/```(\w*)\n([\s\S]*?)```/g,(m,lang,code)=>'<pre><code class="lang-'+lang+'">'+code.trim()+'</code><button class="copy-btn" onclick="copyCode(this)">Copy</button></pre>')
    // Inline code
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    // Bold
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    // Italic
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    // Links
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>')
    // Unordered lists
    .replace(/^[-*] (.+)$/gm,'<li>$1</li>')
    // Numbered lists
    .replace(/^\d+\. (.+)$/gm,'<li>$1</li>')
    // Paragraphs
    .replace(/\n\n/g,'</p><p>')
    .replace(/\n/g,'<br>');
  // Wrap consecutive <li> in <ul>
  h=h.replace(/((?:<li>.*?<\/li>(?:<br>)?)+)/g,'<ul>$1</ul>');
  return'<p>'+h+'</p>';
}
function copyCode(btn){const code=btn.previousElementSibling;navigator.clipboard.writeText(code.textContent);btn.textContent='Copied!';setTimeout(()=>btn.textContent='Copy',1500)}

function addMsg(role,text,meta,images){
  const m=document.getElementById('messages');
  const empty=m.querySelector('.empty-chat');if(empty)empty.remove();
  const d=document.createElement('div');d.className='msg '+role;
  const name=role==='user'?(currentThread?.username?'@'+currentThread.username:'You'):(currentAgent||'Agent');
  let imgHtml='';
  if(images&&images.length>0){
    imgHtml='<div class="msg-images">'+images.map(i=>'<img src="'+(i.preview||('data:'+i.mediaType+';base64,'+i.data))+'">').join('')+'</div>';
  }
  const bubbleContent=role==='assistant'?renderMd(text):escapeHtml(text);
  d.innerHTML='<div class="msg-header">'+(role==='assistant'?'‚öõ ':'')+name+'</div>'+imgHtml+'<div class="msg-bubble">'+bubbleContent+'</div>'+(meta?'<div class="msg-meta">'+meta+'</div>':'');
  m.appendChild(d);m.scrollTop=m.scrollHeight;
}
function escapeHtml(t){if(!t)return'';return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>')}

function sendMsg(){
  const i=document.getElementById('chat-input'),msg=i.value.trim();
  if((!msg&&!pendingImages.length)||!ws||ws.readyState!==1)return;
  const sendBtn=document.getElementById('chat-send');if(sendBtn)sendBtn.disabled=true;
  const imgs=pendingImages.length>0?pendingImages.map(x=>({data:x.data,mediaType:x.mediaType})):undefined;
  addMsg('user',msg||'(image)',null,pendingImages.length>0?pendingImages:undefined);
  ws.send(JSON.stringify({message:msg||'What do you see?',agent:currentAgent||undefined,images:imgs}));
  i.value='';i.style.height='auto';
  pendingImages=[];
  document.getElementById('image-preview').innerHTML='';
  setTimeout(()=>{const sb=document.getElementById('chat-send');if(sb)sb.disabled=!ws||ws.readyState!==1},100);
}
document.getElementById('chat-send').onclick=sendMsg;
document.getElementById('chat-input').onkeydown=(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg()}};

// Auto-resize textarea
document.getElementById('chat-input').oninput=function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'};

// ‚îÄ‚îÄ‚îÄ Image Handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addImageToPreview(file){
  if(!file.type.startsWith('image/'))return;
  const reader=new FileReader();
  reader.onload=(e)=>{
    const dataUrl=e.target.result;
    const base64=dataUrl.split(',')[1];
    const mediaType=file.type||'image/jpeg';
    pendingImages.push({data:base64,mediaType,preview:dataUrl});
    renderImagePreviews();
  };
  reader.readAsDataURL(file);
}
function renderImagePreviews(){
  const p=document.getElementById('image-preview');
  p.innerHTML=pendingImages.map((img,i)=>'<div class="image-preview-item"><img src="'+img.preview+'"><button class="remove" onclick="removeImage('+i+')">√ó</button></div>').join('');
}
function removeImage(i){pendingImages.splice(i,1);renderImagePreviews()}

// Paste from clipboard
document.getElementById('chat-input').addEventListener('paste',(e)=>{
  const items=e.clipboardData?.items;
  if(!items)return;
  for(const item of items){
    if(item.type.startsWith('image/')){
      e.preventDefault();
      const file=item.getAsFile();
      if(file)addImageToPreview(file);
    }
  }
});

// File input
document.getElementById('upload-btn').onclick=()=>document.getElementById('file-input').click();
document.getElementById('file-input').onchange=(e)=>{
  for(const f of e.target.files)addImageToPreview(f);
  e.target.value='';
};

// Drag and drop
const chatPane=document.querySelector('.chat-pane');
const dropOverlay=document.getElementById('drop-overlay');
let dragCount=0;
chatPane.addEventListener('dragenter',(e)=>{e.preventDefault();dragCount++;dropOverlay.style.display='flex'});
chatPane.addEventListener('dragleave',(e)=>{e.preventDefault();dragCount--;if(dragCount<=0){dragCount=0;dropOverlay.style.display='none'}});
chatPane.addEventListener('dragover',(e)=>e.preventDefault());
chatPane.addEventListener('drop',(e)=>{
  e.preventDefault();dragCount=0;dropOverlay.style.display='none';
  for(const f of e.dataTransfer.files)addImageToPreview(f);
});

async function refreshThreads(){try{const[tR,aR]=await Promise.all([api('/api/threads'),api('/api/agents')]);const threads=await tR.json(),agents=await aR.json();const sel=document.getElementById('agent-select');if(sel.options.length!==agents.length){sel.innerHTML=agents.map(a=>'<option value="'+a.name+'"'+(a.isPrimary?' selected':'')+'>'+a.name+(a.isPrimary?' (primary)':'')+'</option>').join('');currentAgent=sel.value}document.getElementById('agent-badge').textContent=currentAgent||'echo';const icons={telegram:'üì±',dashboard:'üíª',whatsapp:'üì≤',discord:'üéÆ'};document.getElementById('thread-items').innerHTML=threads.map(t=>{const icon=icons[t.channel]||'üí¨';const name=t.username?'@'+t.username:(t.channel==='dashboard'?'Dashboard':t.channel);const active=currentThread?.channel===t.channel&&currentThread?.userId===t.user_id?'active':'';return'<div class="thread-item '+active+'" onclick="selectThread(\''+t.channel+"','"+( t.user_id||'')+"','"+(t.username||'')+"')\"><div class=\"thread-item-name\"><span>"+icon+"</span>"+name+'</div><div class="thread-item-meta"><span>'+t.messageCount+' msgs</span><span>'+timeAgo(t.lastMessage)+'</span></div></div>'}).join('')||'<div style="padding:16px;color:var(--text-dim);font-size:.8rem;text-align:center">No conversations yet</div>'}catch{}}
document.getElementById('agent-select').onchange=(e)=>{currentAgent=e.target.value;refreshThreads()};
async function selectThread(ch,uid,uname){currentThread={channel:ch,userId:uid||null,username:uname||null};document.querySelectorAll('.thread-item').forEach(t=>t.classList.remove('active'));const m=document.getElementById('messages');m.innerHTML='<div class="empty-chat"><span class="loading-spinner">‚ãØ</span><span>Loading conversation...</span></div>';const ps=new URLSearchParams({channel:ch,limit:'50'});if(uid)ps.set('userId',uid);try{const r=await api('/api/threads/history?'+ps);const h=await r.json();m.innerHTML='';if(!h.length){m.innerHTML='<div class="empty-chat"><span>üí¨</span><span>No messages yet</span></div>';return}h.forEach(x=>addMsg(x.role,x.content,x.model?(x.tier||'')+' ‚Üí '+x.model:null))}catch(e){m.innerHTML='<div class="empty-chat"><span style="color:var(--red)">!</span><span>Could not load. Try again.</span></div>'}setTimeout(()=>{document.querySelectorAll('.thread-item').forEach(t=>{if(t.textContent.includes(uname||ch))t.classList.add('active')})},50)}
document.getElementById('new-chat-btn').onclick=()=>{currentThread={channel:'dashboard',userId:null,username:null};document.querySelectorAll('.thread-item').forEach(t=>t.classList.remove('active'));document.getElementById('messages').innerHTML='<div class="empty-chat"><span>‚öõ</span><span>Start typing below</span></div>';document.getElementById('chat-input').focus()};
function highlightThread(ch,uname){document.querySelectorAll('.thread-item').forEach(t=>{if(t.textContent.includes(uname||ch)){t.style.background='var(--accent-bg)';setTimeout(()=>{t.style.background=''},2000)}})}
function timeAgo(ts){if(!ts)return'';const d=Date.now()-new Date(ts).getTime();if(d<60000)return'now';if(d<3600000)return Math.floor(d/60000)+'m';if(d<86400000)return Math.floor(d/3600000)+'h';return Math.floor(d/86400000)+'d'}

async function loadPairings(){try{const r=await api('/api/pairing/pending');if(!r.ok)return;const d=await r.json();const bar=document.getElementById('pairing-banner'),list=document.getElementById('pairing-list');if(!d.length){bar.style.display='none';return}bar.style.display='block';list.innerHTML=d.map(p=>{const age=Math.round((Date.now()-p.timestamp)/60000);return'<div class="pairing-item"><span>@'+(p.username||'?')+' ('+p.channel+') ‚Äî <code>'+p.code+'</code> ‚Äî '+age+'m</span><button onclick="approvePair(\''+p.channel+"','"+p.code+"')\">Approve</button></div>"}).join('')}catch{}}
async function approvePair(ch,code){const r=await api('/api/pairing/approve',{method:'POST',body:{channel:ch,code}});if(r.ok)addMsg('assistant','‚úì Paired on '+ch);loadPairings()}
setInterval(loadPairings,15000);

const pageNames={chat:'Chat',overview:'Overview',channels:'Channels',usage:'Usage',agents:'Agents',skills:'Skills',memory:'Memory',config:'Config',logs:'Logs'};
document.querySelectorAll('.nav-item[data-page]').forEach(item=>{item.onclick=()=>{const pg=item.dataset.page;doPage(pg)};item.onkeydown=(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();doPage(item.dataset.page)}}});
function doPage(pg){if(pg!=='logs'&&logsLiveInterval){clearInterval(logsLiveInterval);logsLiveInterval=null;const lb=document.getElementById('logs-live-btn');if(lb){lb.textContent='Live (5s)';lb.classList.remove('badge-accent')}}document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));document.querySelector('.nav-item[data-page="'+pg+'"]')?.classList.add('active');document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+pg)?.classList.add('active');document.getElementById('page-title').textContent=pageNames[pg]||pg;if(pg==='overview')loadOverview();if(pg==='channels')loadChannels();if(pg==='usage')loadUsage();if(pg==='agents')loadAgents();if(pg==='skills')loadSkills();if(pg==='memory')loadMemory();if(pg==='config')loadConfig();if(pg==='logs')loadLogs();if(pg==='chat')refreshThreads()}

async function loadOverview(){try{const[hR,sR]=await Promise.all([api('/api/health'),api('/api/stats')]);const h=await hR.json(),s=await sR.json();document.getElementById('overview-cards').innerHTML='<div class="card"><div class="card-label">Status</div><div class="card-value" style="color:var(--green)">Running</div><div class="card-sub">Degradation: '+h.degradationLevel+'/5</div></div><div class="card"><div class="card-label">Agents</div><div class="card-value">'+(h.agents||0)+'</div></div><div class="card"><div class="card-label">Memory</div><div class="card-value">'+(h.cognee?'Graph':'Local')+'</div><div class="card-sub">'+(h.cognee?'Cognee':'Vector + SQLite')+'</div></div><div class="card"><div class="card-label">Tunnel</div><div class="card-value" style="font-size:.9rem">'+(h.tunnel?'Active':'Localhost')+'</div><div class="card-sub">'+(h.tunnel||'No public URL')+'</div></div><div class="card"><div class="card-label">AGEX</div><div class="card-value">'+(h.agex?.mode||'local')+'</div></div>';document.getElementById('overview-stats').innerHTML='<div class="card"><div class="card-label">Messages</div><div class="card-value">'+(s.memory?.total||0)+'</div><div class="card-sub">'+(s.memory?.today||0)+' today</div></div><div class="card"><div class="card-label">Cost</div><div class="card-value">¬£'+(s.costs?.total||0).toFixed(4)+'</div></div><div class="card"><div class="card-label">Tokens</div><div class="card-value">'+(s.costs?.tokens||0).toLocaleString()+'</div></div>'}catch(e){document.getElementById('overview-cards').innerHTML='<div class="card"><div class="card-value" style="color:var(--red)">Error</div><div class="card-sub">'+e.message+'</div></div>'}}
async function loadChannels(){try{const[cR,tR]=await Promise.all([api('/api/channels'),api('/api/threads')]);const ch=await cR.json(),threads=await tR.json();document.getElementById('channel-cards').innerHTML=ch.map(c=>{const icon=c.name==='telegram'?'üì±':c.name==='dashboard'?'üíª':'üì°';return'<div class="card"><div class="card-label">'+icon+' '+c.name+'</div><div class="card-value" style="color:var(--green)">Active</div><div class="card-sub">'+(c.botName?'@'+c.botName+'<br>':'')+(c.paired?c.paired+' paired users':'')+(c.tunnel?'<br>'+c.tunnel:'')+'</div></div>'}).join('');document.getElementById('paired-table').innerHTML=threads.map(t=>'<tr><td>'+t.channel+'</td><td>'+(t.username?'@'+t.username:(t.channel==='dashboard'?'Dashboard':t.user_id||'‚Äî'))+'</td><td>'+t.messageCount+'</td><td>'+timeAgo(t.lastMessage)+'</td></tr>').join('')||'<tr><td colspan=4 style="color:var(--text-dim)">No conversations yet</td></tr>'}catch{}}
async function loadUsage(){try{const[sR,aR]=await Promise.all([api('/api/stats'),api('/api/audit?limit=30')]);const s=await sR.json(),audit=await aR.json();document.getElementById('usage-cards').innerHTML='<div class="card"><div class="card-label">Total Spend</div><div class="card-value">¬£'+(s.costs?.total||0).toFixed(4)+'</div></div><div class="card"><div class="card-label">Messages</div><div class="card-value">'+(s.costs?.messages||0)+'</div></div><div class="card"><div class="card-label">Tokens</div><div class="card-value">'+(s.costs?.tokens||0).toLocaleString()+'</div></div>';const byCh=s.memory?.byChannel||[],maxCh=Math.max(...byCh.map(c=>c.count),1),colors=['var(--accent)','var(--green)','var(--blue)','var(--yellow)'];document.getElementById('usage-channels').innerHTML=byCh.map((c,i)=>'<div class="usage-bar-wrap"><div class="usage-bar-label"><span>'+(c.channel||'?')+'</span><span>'+c.count+' msgs</span></div><div class="usage-bar"><div class="usage-bar-fill" style="width:'+(c.count/maxCh*100)+'%;background:'+colors[i%colors.length]+'"></div></div></div>').join('')||'<div style="color:var(--text-dim);font-size:.8rem">No data</div>';const ce=(audit||[]).filter(e=>e.detail?.includes('¬£'));document.getElementById('usage-table').innerHTML=ce.slice(0,20).map(e=>{const t=new Date(e.timestamp).toLocaleTimeString();return'<tr><td>'+t+'</td><td>'+(e.actor||'‚Äî')+'</td><td>'+(e.detail?.match(/^(\w+)/)?.[1]||'‚Äî')+'</td><td style="font-family:JetBrains Mono;font-size:.75rem">'+(e.detail?.match(/‚Üí\s*([^\s(]+)/)?.[1]||'‚Äî')+'</td><td>'+(e.detail?.match(/¬£[\d.]+/)?.[0]||'‚Äî')+'</td></tr>'}).join('')||'<tr><td colspan=5 style="color:var(--text-dim)">No usage yet</td></tr>'}catch{}}
async function loadAgents(){try{const r=await api('/api/agents');const a=await r.json();document.getElementById('agent-cards').innerHTML=a.map(x=>'<div class="card"><div class="card-label">'+(x.isPrimary?'‚öõ Primary':'ü§ñ')+' '+x.name+'</div><div class="card-value" style="color:var(--green);font-size:1rem">Active</div><div class="card-sub">'+x.provider+'/'+x.model+'<br>'+x.skills+' skills ¬∑ '+x.threads+' threads ¬∑ '+x.messages+' msgs</div></div>').join('')||'<div class="card"><div class="card-value">No agents</div></div>'}catch{}}
async function loadSkills(){try{const r=await api('/api/skills');const d=await r.json();document.getElementById('skills-table').innerHTML=d.map(s=>'<tr><td><b>'+s.name+'</b></td><td>'+s.endpoints+'</td><td>'+(s.reviewed?'<span class="badge badge-green">Reviewed</span>':'<span class="badge badge-yellow">Unreviewed</span>')+'</td><td style="color:var(--text-dim)">'+s.source+'</td></tr>').join('')||'<tr><td colspan=4 style="color:var(--text-dim)">No skills</td></tr>'}catch{}}
async function loadMemory(){try{const r=await api('/api/health');const h=await r.json();document.getElementById('memory-cards').innerHTML='<div class="card"><div class="card-label">Graph</div><div class="card-value">'+(h.cognee?'Cognee':'Offline')+'</div><div class="card-sub">'+(h.cognee?'Remote graph':'Local vector + SQLite')+'</div></div><div class="card"><div class="card-label">Vector</div><div class="card-value">Active</div><div class="card-sub">TF-IDF similarity</div></div><div class="card"><div class="card-label">Knowledge</div><div class="card-value">Active</div><div class="card-sub">Facts ¬∑ preferences ¬∑ episodic</div></div>'}catch{}}
async function searchMemory(){const q=document.getElementById('memory-query').value.trim();if(!q)return;const el=document.getElementById('memory-results');el.textContent='Searching...';try{const r=await api('/api/memory/search',{method:'POST',body:{query:q}});const d=await r.json();if(!d.length){el.textContent='No results.';return}el.innerHTML=d.map(x=>'<div style="padding:8px;margin-bottom:8px;background:var(--bg-2);border-radius:6px;border:1px solid var(--border)"><div style="font-size:.78rem">'+(x.content||x.text||JSON.stringify(x))+'</div>'+(x.score?'<div style="font-size:.65rem;color:var(--text-xs);margin-top:4px">Score: '+x.score.toFixed(3)+'</div>':'')+'</div>').join('')}catch(e){el.textContent='Error: '+e.message}}
async function loadConfig(){try{const r=await api('/api/config');const cfg=await r.json();const ed=document.getElementById('config-editor');function rO(obj,pfx=''){let h='';for(const[k,v]of Object.entries(obj)){const fk=pfx?pfx+'.'+k:k;if(v&&typeof v==='object'&&!Array.isArray(v)){h+='<div style="margin-top:12px;margin-bottom:4px;font-weight:600;font-size:.8rem;color:var(--accent-l)">'+fk+'</div>';h+=rO(v,fk)}else{const d=v==='***'?'***':JSON.stringify(v);const ok=v!=='***';h+='<div class="config-row"><div class="config-key">'+k+'</div><div class="config-val">'+(ok?'<input value="'+String(v).replace(/"/g,'&quot;')+'" onkeydown="if(event.key===\'Enter\')saveConfig(\''+fk+"',this.value)\">":"<span style=\"color:var(--text-dim)\">"+d+'</span>')+'</div>'+(ok?'<button class="btn-sm" onclick="saveConfig(\''+fk+"',this.parentElement.querySelector('input').value)\">Save</button>":'')+'</div>'}}return h}ed.innerHTML=rO(cfg)}catch(e){document.getElementById('config-editor').innerHTML='<div style="color:var(--red)">Error: '+e.message+'</div>'}}
async function saveConfig(key,value){try{const r=await api('/api/config',{method:'POST',body:{key,value}});if((await r.json()).ok){event.target.style.background='var(--green)';setTimeout(()=>{event.target.style.background=''},600)}}catch{}}
async function loadLogs(filter){try{const r=await api('/api/audit?limit=100');let d=await r.json();if(filter==='error')d=d.filter(e=>e.action==='error'||e.action==='warning');const lv=document.getElementById('log-viewer');if(!d.length){lv.innerHTML='<div class="log-line info">No entries.</div>';return}lv.innerHTML=d.map(l=>'<div class="log-line '+(l.action==='error'?'error':l.action==='warning'?'warn':'info')+'">['+new Date(l.timestamp).toLocaleTimeString()+'] '+l.actor+' ‚Üí '+l.action+(l.detail?' ‚Äî '+l.detail:'')+'</div>').join('');lv.scrollTop=lv.scrollHeight}catch{document.getElementById('log-viewer').innerHTML='<div class="log-line error">Error loading logs</div>'}}
let logsLiveInterval=null;
function toggleLogsLive(){const btn=document.getElementById('logs-live-btn');if(logsLiveInterval){clearInterval(logsLiveInterval);logsLiveInterval=null;btn.textContent='Live (5s)';btn.classList.remove('badge-accent');return}btn.textContent='Live on';btn.classList.add('badge-accent');loadLogs();logsLiveInterval=setInterval(()=>loadLogs(),5000);}

if(TOKEN){refreshThreads();setInterval(refreshThreads,10000)}
</script>
</body>
</html>
