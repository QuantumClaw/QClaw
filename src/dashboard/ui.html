<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>QClaw Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:       #0a0a0f;
      --bg-1:     #111118;
      --bg-2:     #1a1a24;
      --bg-3:     #222233;
      --border:   #2a2a3a;
      --text:     #e4e4ef;
      --text-dim: #7777aa;
      --accent:   #9333ea;
      --accent-l: #c084fc;
      --green:    #22c55e;
      --red:      #ef4444;
      --yellow:   #f59e0b;
      --blue:     #3b82f6;
      --cyan:     #06b6d4;
      --sidebar-w: 220px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:'Outfit',sans-serif; display:flex; height:100vh; overflow:hidden; }

    /* â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      width:var(--sidebar-w); background:var(--bg-1); border-right:1px solid var(--border);
      display:flex; flex-direction:column; flex-shrink:0; overflow-y:auto;
    }
    .sidebar-logo {
      padding:1.2rem 1rem; border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:0.6rem;
    }
    .sidebar-logo span:first-child { font-size:1.4rem; }
    .sidebar-logo span:last-child { font-family:'JetBrains Mono'; font-weight:600; font-size:0.95rem; letter-spacing:0.05em; }

    .sidebar-group { padding:0.8rem 0 0.4rem; }
    .sidebar-group-label {
      padding:0 1rem 0.4rem; font-size:0.65rem; font-weight:600;
      text-transform:uppercase; letter-spacing:0.12em; color:var(--text-dim);
    }
    .sidebar-item {
      display:flex; align-items:center; gap:0.6rem;
      padding:0.5rem 1rem; cursor:pointer; font-size:0.85rem;
      color:var(--text-dim); transition:all 0.15s;
      border-left:2px solid transparent;
    }
    .sidebar-item:hover { color:var(--text); background:var(--bg-2); }
    .sidebar-item.active {
      color:var(--accent-l); background:var(--bg-2);
      border-left-color:var(--accent);
    }
    .sidebar-item .icon { width:16px; text-align:center; font-size:0.9rem; }

    .sidebar-footer {
      margin-top:auto; padding:0.8rem 1rem; border-top:1px solid var(--border);
      font-size:0.75rem; color:var(--text-dim);
    }
    .sidebar-footer .status-dot {
      display:inline-block; width:8px; height:8px; border-radius:50%;
      background:var(--green); margin-right:0.4rem;
    }
    .sidebar-footer.offline .status-dot { background:var(--red); }

    /* â”€â”€â”€ Main area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main { flex:1; display:flex; flex-direction:column; overflow:hidden; }

    .topbar {
      padding:0.6rem 1.2rem; border-bottom:1px solid var(--border);
      background:var(--bg-1); display:flex; align-items:center; gap:1rem;
      font-size:0.85rem;
    }
    .topbar-title { font-weight:600; }
    .topbar-right { margin-left:auto; display:flex; gap:0.8rem; align-items:center; }
    .topbar-badge {
      padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem; font-weight:600;
    }
    .badge-green { background:rgba(34,197,94,0.15); color:var(--green); }
    .badge-yellow { background:rgba(245,158,11,0.15); color:var(--yellow); }
    .badge-red { background:rgba(239,68,68,0.15); color:var(--red); }

    .content { flex:1; overflow-y:auto; }
    .page { display:none; height:100%; }
    .page.active { display:flex; flex-direction:column; }

    /* â”€â”€â”€ Chat page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-messages { flex:1; overflow-y:auto; padding:1rem 1.5rem; }
    .msg { margin-bottom:1rem; max-width:75%; }
    .msg.user { margin-left:auto; }
    .msg-role { font-size:0.7rem; color:var(--text-dim); margin-bottom:0.2rem; }
    .msg-bubble {
      padding:0.7rem 1rem; border-radius:10px; line-height:1.5;
      white-space:pre-wrap; word-break:break-word; font-size:0.9rem;
    }
    .msg.user .msg-bubble { background:var(--accent); color:white; border-bottom-right-radius:3px; }
    .msg.assistant .msg-bubble { background:var(--bg-2); border:1px solid var(--border); border-bottom-left-radius:3px; }
    .msg-meta { font-size:0.65rem; color:var(--text-dim); margin-top:0.2rem; }
    .typing { color:var(--text-dim); font-style:italic; padding:0.5rem 1.5rem; display:none; font-size:0.85rem; }

    .chat-input {
      display:flex; gap:0.5rem; padding:0.8rem 1.2rem;
      border-top:1px solid var(--border); background:var(--bg-1);
    }
    .chat-input input {
      flex:1; background:var(--bg-2); border:1px solid var(--border);
      color:var(--text); padding:0.7rem 1rem; border-radius:8px;
      font-family:'Outfit'; font-size:0.9rem; outline:none;
    }
    .chat-input input:focus { border-color:var(--accent); }
    .chat-input button {
      background:var(--accent); color:white; border:none;
      padding:0.7rem 1.4rem; border-radius:8px; cursor:pointer;
      font-weight:600; font-family:'Outfit'; font-size:0.85rem;
    }
    .chat-input button:hover { background:var(--accent-l); }

    /* â”€â”€â”€ Pairing bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pairing-bar { display:none; background:rgba(245,158,11,0.08); border-bottom:1px solid var(--yellow); padding:0.5rem 1.2rem; }
    .pairing-item { display:flex; align-items:center; justify-content:space-between; font-size:0.82rem; padding:0.2rem 0; }
    .pairing-item code { background:var(--bg); padding:0.1rem 0.4rem; border-radius:3px; font-family:'JetBrains Mono'; font-weight:600; letter-spacing:0.08em; }
    .pairing-item button { background:var(--green); color:#000; border:none; padding:0.25rem 0.7rem; border-radius:5px; cursor:pointer; font-weight:600; font-size:0.75rem; }

    /* â”€â”€â”€ Card grid (for overview, settings etc) â”€â”€ */
    .card-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:1rem; padding:1.2rem; }
    .card {
      background:var(--bg-2); border:1px solid var(--border); border-radius:10px;
      padding:1rem 1.2rem; transition:border-color 0.2s;
    }
    .card:hover { border-color:var(--accent); }
    .card-title { font-size:0.75rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.5rem; }
    .card-value { font-size:1.6rem; font-weight:700; font-family:'JetBrains Mono'; }
    .card-sub { font-size:0.78rem; color:var(--text-dim); margin-top:0.3rem; }

    /* â”€â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .data-table { width:100%; border-collapse:collapse; font-size:0.85rem; }
    .data-table th {
      text-align:left; padding:0.6rem 1rem; font-size:0.7rem;
      text-transform:uppercase; letter-spacing:0.08em; color:var(--text-dim);
      border-bottom:1px solid var(--border); background:var(--bg-1);
      position:sticky; top:0;
    }
    .data-table td { padding:0.6rem 1rem; border-bottom:1px solid var(--border); }
    .data-table tr:hover td { background:var(--bg-2); }

    /* â”€â”€â”€ Log viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .log-viewer {
      flex:1; overflow-y:auto; padding:0.8rem 1rem; font-family:'JetBrains Mono';
      font-size:0.78rem; line-height:1.8; background:var(--bg);
    }
    .log-line { white-space:pre-wrap; word-break:break-all; }
    .log-line.info { color:var(--text-dim); }
    .log-line.success { color:var(--green); }
    .log-line.warn { color:var(--yellow); }
    .log-line.error { color:var(--red); }

    /* â”€â”€â”€ Config editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .config-editor {
      flex:1; margin:1rem; background:var(--bg-1); border:1px solid var(--border);
      border-radius:8px; overflow:auto;
    }
    .config-editor pre {
      padding:1rem; font-family:'JetBrains Mono'; font-size:0.8rem;
      line-height:1.6; color:var(--text); white-space:pre-wrap;
    }

    /* â”€â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      height:100%; color:var(--text-dim); text-align:center; padding:2rem;
    }
    .empty-state .icon { font-size:2.5rem; margin-bottom:1rem; opacity:0.5; }
    .empty-state p { font-size:0.9rem; max-width:300px; line-height:1.5; }

    /* â”€â”€â”€ Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width:768px) {
      .sidebar { display:none; position:fixed; z-index:100; height:100%; }
      .sidebar.open { display:flex; }
      .mobile-toggle { display:block !important; }
    }
    .mobile-toggle { display:none; background:none; border:none; color:var(--text); font-size:1.2rem; cursor:pointer; padding:0.3rem; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <span>âš›</span>
      <span>QClaw</span>
    </div>

    <div class="sidebar-group">
      <div class="sidebar-group-label">Chat</div>
      <div class="sidebar-item active" data-page="chat"><span class="icon">ğŸ’¬</span> Chat</div>
    </div>

    <div class="sidebar-group">
      <div class="sidebar-group-label">Control</div>
      <div class="sidebar-item" data-page="overview"><span class="icon">ğŸ“Š</span> Overview</div>
      <div class="sidebar-item" data-page="channels"><span class="icon">ğŸ“¡</span> Channels</div>
      <div class="sidebar-item" data-page="instances"><span class="icon">ğŸ–¥ï¸</span> Instances</div>
      <div class="sidebar-item" data-page="sessions"><span class="icon">ğŸ”—</span> Sessions</div>
      <div class="sidebar-item" data-page="usage"><span class="icon">ğŸ“ˆ</span> Usage</div>
      <div class="sidebar-item" data-page="cron"><span class="icon">â°</span> Cron Jobs</div>
    </div>

    <div class="sidebar-group">
      <div class="sidebar-group-label">Agent</div>
      <div class="sidebar-item" data-page="agents"><span class="icon">ğŸ¤–</span> Agents</div>
      <div class="sidebar-item" data-page="skills"><span class="icon">ğŸ”§</span> Skills</div>
      <div class="sidebar-item" data-page="nodes"><span class="icon">ğŸ”Œ</span> Nodes</div>
    </div>

    <div class="sidebar-group">
      <div class="sidebar-group-label">Settings</div>
      <div class="sidebar-item" data-page="config"><span class="icon">âš™ï¸</span> Config</div>
      <div class="sidebar-item" data-page="debug"><span class="icon">ğŸ”</span> Debug</div>
      <div class="sidebar-item" data-page="logs"><span class="icon">ğŸ“‹</span> Logs</div>
      <div class="sidebar-item" data-page="resources"><span class="icon">ğŸ’¾</span> Resources</div>
      <div class="sidebar-item" data-page="docs"><span class="icon">ğŸ“–</span> Docs</div>
    </div>

    <div class="sidebar-footer" id="sidebar-footer">
      <span class="status-dot"></span> Connecting...
    </div>
  </nav>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <button class="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>
      <span class="topbar-title" id="page-title">Chat</span>
      <div class="topbar-right">
        <span class="topbar-badge badge-green" id="status-badge">â—</span>
      </div>
    </div>

    <div class="content">

      <!-- CHAT PAGE -->
      <div class="page active" id="page-chat">
        <div class="pairing-bar" id="pairing-bar"><div id="pairing-list"></div></div>
        <div class="chat-messages" id="messages"></div>
        <div class="typing" id="typing">Thinking...</div>
        <div class="chat-input">
          <input type="text" id="chat-input" placeholder="Talk to your agent..." autofocus>
          <button id="chat-send">Send</button>
        </div>
      </div>

      <!-- OVERVIEW PAGE -->
      <div class="page" id="page-overview">
        <div class="card-grid" id="overview-cards"></div>
      </div>

      <!-- CHANNELS PAGE -->
      <div class="page" id="page-channels">
        <div style="overflow:auto;padding:0">
          <table class="data-table" id="channels-table">
            <thead><tr><th>Channel</th><th>Status</th><th>Users</th><th>Messages</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- SESSIONS PAGE -->
      <div class="page" id="page-sessions">
        <div style="overflow:auto;padding:0">
          <table class="data-table" id="sessions-table">
            <thead><tr><th>Session</th><th>Channel</th><th>Age</th><th>Messages</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- INSTANCES PAGE -->
      <div class="page" id="page-instances">
        <div class="card-grid" id="instances-cards"></div>
      </div>

      <!-- CRON JOBS PAGE -->
      <div class="page" id="page-cron">
        <div style="overflow:auto;padding:0">
          <table class="data-table" id="cron-table">
            <thead><tr><th>Job</th><th>Schedule</th><th>Last Run</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- USAGE PAGE -->
      <div class="page" id="page-usage">
        <div class="card-grid" id="usage-cards"></div>
      </div>

      <!-- AGENTS PAGE -->
      <div class="page" id="page-agents">
        <div style="overflow:auto;padding:0">
          <table class="data-table" id="agents-table">
            <thead><tr><th>Agent</th><th>Model</th><th>Status</th><th>Skills</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- SKILLS PAGE -->
      <div class="page" id="page-skills">
        <div style="overflow:auto;padding:0">
          <table class="data-table" id="skills-table">
            <thead><tr><th>Skill</th><th>Endpoints</th><th>Status</th><th>Source</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- NODES PAGE -->
      <div class="page" id="page-nodes">
        <div class="card-grid" id="nodes-cards"></div>
      </div>

      <!-- CONFIG PAGE -->
      <div class="page" id="page-config">
        <div class="config-editor"><pre id="config-json">Loading...</pre></div>
      </div>

      <!-- LOGS PAGE -->
      <div class="page" id="page-logs">
        <div class="log-viewer" id="log-viewer"></div>
      </div>

      <!-- DEBUG PAGE -->
      <div class="page" id="page-debug">
        <div class="card-grid" id="debug-cards"></div>
      </div>

      <!-- RESOURCES PAGE -->
      <div class="page" id="page-resources">
        <div class="card-grid" id="resources-cards"></div>
      </div>

      <!-- DOCS PAGE -->
      <div class="page" id="page-docs">
        <div style="padding:1.5rem">
          <div style="max-width:700px">
            <h2 style="font-size:1.3rem;margin-bottom:1rem;font-weight:600">Documentation</h2>
            <div class="card" style="margin-bottom:0.8rem;cursor:pointer" onclick="window.open('https://github.com/QuantumClaw/QClaw','_blank')">
              <div class="card-title">GitHub Repository</div>
              <div class="card-sub">Source code, issues, and releases</div>
            </div>
            <div class="card" style="margin-bottom:0.8rem;cursor:pointer" onclick="window.open('https://agexhq.com','_blank')">
              <div class="card-title">AGEX Protocol</div>
              <div class="card-sub">Agent Gateway Exchange specification</div>
            </div>
            <div class="card" style="margin-bottom:0.8rem">
              <div class="card-title">CLI Reference</div>
              <div class="card-sub" style="font-family:'JetBrains Mono';font-size:0.75rem;line-height:2;margin-top:0.5rem">
                qclaw start â€” Start agent runtime<br>
                qclaw onboard â€” Setup wizard<br>
                qclaw dashboard â€” Open dashboard<br>
                qclaw diagnose â€” Health check<br>
                qclaw pairing list â€” Show pending pairings<br>
                qclaw pairing approve &lt;ch&gt; &lt;code&gt; â€” Approve pairing
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
// â”€â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const hp = new URLSearchParams(location.hash.slice(1));
const qp = new URLSearchParams(location.search);
let TOKEN = hp.get('token') || qp.get('token') || localStorage.getItem('qclaw_token') || '';
if (TOKEN) { localStorage.setItem('qclaw_token', TOKEN); if (location.hash) history.replaceState(null,'',location.pathname); }

// If no token, show prompt
if (!TOKEN) {
  document.querySelector('.sidebar').style.display='none';
  document.querySelector('.main').innerHTML=`
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg)">
      <div style="text-align:center;max-width:360px;padding:2rem">
        <div style="font-size:2rem;margin-bottom:1rem">âš›</div>
        <h2 style="font-size:1.2rem;margin-bottom:0.5rem;font-weight:600">QClaw Dashboard</h2>
        <p style="color:var(--text-dim);font-size:0.85rem;margin-bottom:1.5rem">Enter your auth token to connect.</p>
        <input id="token-input" type="text" placeholder="Paste token here" style="width:100%;padding:0.7rem 1rem;background:var(--bg-2);border:1px solid var(--border);color:var(--text);border-radius:8px;font-family:JetBrains Mono;font-size:0.85rem;outline:none;margin-bottom:0.8rem">
        <button onclick="submitToken()" style="width:100%;padding:0.7rem;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-family:Outfit;font-size:0.9rem">Connect</button>
        <p style="color:var(--text-dim);font-size:0.75rem;margin-top:1rem">Run <code style="background:var(--bg-2);padding:0.15rem 0.4rem;border-radius:3px">qclaw dashboard</code> to get the full URL with token.</p>
      </div>
    </div>`;
  document.getElementById('token-input').addEventListener('keydown',e=>{if(e.key==='Enter')submitToken()});
  document.getElementById('token-input').focus();
}
function submitToken(){
  const t=document.getElementById('token-input').value.trim();
  if(t){localStorage.setItem('qclaw_token',t);location.reload();}
}

async function api(path, opts={}) {
  const h = {...(opts.headers||{}), 'Authorization':'Bearer '+TOKEN};
  if (opts.body && typeof opts.body==='object') { h['Content-Type']='application/json'; opts.body=JSON.stringify(opts.body); }
  return fetch(path,{...opts,headers:h});
}

// â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ws = new WebSocket((location.protocol==='https:'?'wss:':'ws:')+'//'+location.host+'/ws'+(TOKEN?'?token='+TOKEN:''));
const footer = document.getElementById('sidebar-footer');
const badge = document.getElementById('status-badge');

ws.onopen = () => { footer.innerHTML='<span class="status-dot"></span> Connected'; footer.classList.remove('offline'); badge.className='topbar-badge badge-green'; badge.textContent='â— Online'; loadOverview(); loadPairings(); };
ws.onclose = () => { footer.innerHTML='<span class="status-dot"></span> Disconnected'; footer.classList.add('offline'); badge.className='topbar-badge badge-red'; badge.textContent='â— Offline'; };

ws.onmessage = (e) => {
  const d = JSON.parse(e.data);
  if (d.type==='typing') document.getElementById('typing').style.display='block';
  else if (d.type==='response') { document.getElementById('typing').style.display='none'; addMsg('assistant',d.content,d.model?d.tier+' â†’ '+d.model+' (Â£'+(d.cost||0).toFixed(4)+')':'reflex'); }
  else if (d.type==='error') { document.getElementById('typing').style.display='none'; addMsg('assistant','Error: '+d.error); }
};

// â”€â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMsg(role,text,meta) {
  const m=document.getElementById('messages'); const d=document.createElement('div');
  d.className='msg '+role;
  d.innerHTML='<div class="msg-role">'+(role==='user'?'You':'Agent')+'</div><div class="msg-bubble"></div>'+(meta?'<div class="msg-meta">'+meta+'</div>':'');
  d.querySelector('.msg-bubble').textContent=text;
  m.appendChild(d); m.scrollTop=m.scrollHeight;
}
function sendMsg() {
  const i=document.getElementById('chat-input'), msg=i.value.trim();
  if(!msg)return; addMsg('user',msg); ws.send(JSON.stringify({message:msg})); i.value='';
}
document.getElementById('chat-send').onclick=sendMsg;
document.getElementById('chat-input').onkeydown=(e)=>{if(e.key==='Enter')sendMsg()};

// â”€â”€â”€ Pairing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPairings() {
  try {
    const r=await api('/api/pairing/pending'); if(!r.ok)return;
    const d=await r.json(), bar=document.getElementById('pairing-bar'), list=document.getElementById('pairing-list');
    if(!d.length){bar.style.display='none';return;}
    bar.style.display='block';
    list.innerHTML=d.map(p=>{
      const age=Math.round((Date.now()-p.timestamp)/60000);
      return '<div class="pairing-item"><span>ğŸ” <b>@'+(p.username||'unknown')+'</b> ('+p.channel+') â€” <code>'+p.code+'</code> â€” '+age+'m</span><button onclick="approvePair(\''+p.channel+'\',\''+p.code+'\')">Approve</button></div>';
    }).join('');
  } catch{}
}
async function approvePair(ch,code) {
  const r=await api('/api/pairing/approve',{method:'POST',body:{channel:ch,code}});
  if(r.ok){const d=await r.json();addMsg('assistant','âœ“ Paired @'+(d.username||'user')+' on '+ch);} else addMsg('assistant','Pairing failed');
  loadPairings();
}
setInterval(loadPairings,15000);

// â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pages = {
  chat:'Chat', overview:'Overview', channels:'Channels', instances:'Instances',
  sessions:'Sessions', usage:'Usage', cron:'Cron Jobs',
  agents:'Agents', skills:'Skills', nodes:'Nodes',
  config:'Config', debug:'Debug', logs:'Logs', resources:'Resources', docs:'Docs'
};
document.querySelectorAll('.sidebar-item').forEach(item => {
  item.onclick = () => {
    const pg = item.dataset.page;
    document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
    item.classList.add('active');
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById('page-'+pg).classList.add('active');
    document.getElementById('page-title').textContent = pages[pg]||pg;
    document.getElementById('sidebar').classList.remove('open');
    // Load data for page
    if(pg==='overview') loadOverview();
    if(pg==='channels') loadChannels();
    if(pg==='instances') loadInstances();
    if(pg==='sessions') loadSessions();
    if(pg==='usage') loadUsage();
    if(pg==='cron') loadCron();
    if(pg==='agents') loadAgents();
    if(pg==='skills') loadSkills();
    if(pg==='nodes') loadNodes();
    if(pg==='config') loadConfig();
    if(pg==='logs') loadLogs();
    if(pg==='debug') loadDebug();
    if(pg==='resources') loadResources();
  };
});

// â”€â”€â”€ Data Loaders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOverview() {
  try {
    const r=await api('/api/health'); const d=await r.json();
    document.getElementById('overview-cards').innerHTML=`
      <div class="card"><div class="card-title">Status</div><div class="card-value" style="color:var(--green)">Running</div><div class="card-sub">Degradation: ${d.degradationLevel}/5</div></div>
      <div class="card"><div class="card-title">Agents</div><div class="card-value">${d.agents||0}</div></div>
      <div class="card"><div class="card-title">Memory</div><div class="card-value">${d.cognee?'Cognee':'Local'}</div><div class="card-sub">${d.cognee?'Knowledge graph':'Vector + JSON'}</div></div>
      <div class="card"><div class="card-title">AGEX</div><div class="card-value">${d.agex?.mode||'local'}</div></div>
      <div class="card"><div class="card-title">Tunnel</div><div class="card-value">${d.tunnel?'Active':'None'}</div><div class="card-sub">${d.tunnel||'localhost only'}</div></div>
    `;
  }catch(e){document.getElementById('overview-cards').innerHTML='<div class="card"><div class="card-value" style="color:var(--red)">Error</div><div class="card-sub">'+e.message+'</div></div>';}
}

async function loadChannels() {
  try {
    const r=await api('/api/health'); const d=await r.json();
    const tb=document.querySelector('#channels-table tbody');
    // The health endpoint doesn't have channel details yet, so show from config
    tb.innerHTML='<tr><td>Telegram</td><td><span class="topbar-badge badge-green">Active</span></td><td>â€”</td><td>â€”</td></tr><tr><td>Dashboard</td><td><span class="topbar-badge badge-green">Active</span></td><td>1</td><td>â€”</td></tr>';
  }catch{}
}

async function loadUsage() {
  try {
    const r=await api('/api/costs'); const d=await r.json();
    document.getElementById('usage-cards').innerHTML=`
      <div class="card"><div class="card-title">Total Cost</div><div class="card-value">Â£${(d.total||0).toFixed(4)}</div></div>
      <div class="card"><div class="card-title">Messages</div><div class="card-value">${d.messages||0}</div></div>
      <div class="card"><div class="card-title">Tokens</div><div class="card-value">${(d.tokens||0).toLocaleString()}</div></div>
    `;
  }catch{document.getElementById('usage-cards').innerHTML='<div class="card"><div class="card-value">â€”</div><div class="card-sub">No usage data yet</div></div>';}
}

async function loadAgents() {
  try {
    const r=await api('/api/agents'); const d=await r.json();
    const tb=document.querySelector('#agents-table tbody');
    tb.innerHTML=(Array.isArray(d)?d:[d]).map(a=>'<tr><td><b>'+a.name+'</b></td><td>'+( a.model||'auto')+'</td><td><span class="topbar-badge badge-green">Active</span></td><td>'+(a.skills||0)+'</td></tr>').join('');
  }catch{document.querySelector('#agents-table tbody').innerHTML='<tr><td colspan=4>No agents loaded</td></tr>';}
}

async function loadSkills() {
  try {
    const r=await api('/api/skills'); const d=await r.json();
    const tb=document.querySelector('#skills-table tbody');
    if(!d.length){tb.innerHTML='<tr><td colspan=4>No skills loaded</td></tr>';return;}
    tb.innerHTML=d.map(s=>'<tr><td><b>'+s.name+'</b></td><td>'+s.endpoints+'</td><td>'+(s.reviewed?'<span class="topbar-badge badge-green">Reviewed</span>':'<span class="topbar-badge badge-yellow">Unreviewed</span>')+'</td><td>'+s.source+'</td></tr>').join('');
  }catch{document.querySelector('#skills-table tbody').innerHTML='<tr><td colspan=4>Error loading skills</td></tr>';}
}

async function loadInstances() {
  try {
    const r=await api('/api/health'); const d=await r.json();
    document.getElementById('instances-cards').innerHTML=`
      <div class="card"><div class="card-title">This Instance</div><div class="card-value" style="color:var(--green)">Active</div><div class="card-sub">PID ${d.pid||'â€”'} Â· Degradation ${d.degradationLevel}/5</div></div>
      <div class="card"><div class="card-title">Memory</div><div class="card-value">${d.cognee?'Cognee':'Vector'}</div><div class="card-sub">${d.cognee?'Knowledge graph':'TF-IDF + local'}</div></div>
      <div class="card"><div class="card-title">AGEX</div><div class="card-value">${d.agex?.mode||'local'}</div><div class="card-sub">${d.tunnel||'No tunnel'}</div></div>
    `;
  }catch{}
}

async function loadSessions() {
  try {
    const r=await api('/api/audit?limit=100'); const d=await r.json();
    const tb=document.querySelector('#sessions-table tbody');
    // Extract unique sessions from audit
    const sessions=new Map();
    (d||[]).forEach(e=>{
      const key=e.actor||'unknown';
      if(!sessions.has(key)) sessions.set(key,{channel:e.channel||'dashboard',count:0,last:e.timestamp});
      sessions.get(key).count++;
    });
    if(!sessions.size){tb.innerHTML='<tr><td colspan=4 style="color:var(--text-dim)">No sessions yet</td></tr>';return;}
    tb.innerHTML=[...sessions].map(([k,v])=>{
      const age=Math.round((Date.now()-new Date(v.last).getTime())/60000);
      return '<tr><td>'+k+'</td><td>'+v.channel+'</td><td>'+age+'m</td><td>'+v.count+' events</td></tr>';
    }).join('');
  }catch{document.querySelector('#sessions-table tbody').innerHTML='<tr><td colspan=4>Error</td></tr>';}
}

async function loadCron() {
  const tb=document.querySelector('#cron-table tbody');
  tb.innerHTML='<tr><td colspan=4 style="color:var(--text-dim)">No cron jobs configured. Add via config or skills.</td></tr>';
}

async function loadNodes() {
  try {
    const r=await api('/api/health'); const d=await r.json();
    document.getElementById('nodes-cards').innerHTML=`
      <div class="card"><div class="card-title">Gateway</div><div class="card-value" style="color:var(--green)">Running</div><div class="card-sub">Express + WebSocket</div></div>
      <div class="card"><div class="card-title">Telegram</div><div class="card-value" style="color:var(--green)">Connected</div><div class="card-sub">grammY bot</div></div>
      ${d.tunnel?'<div class="card"><div class="card-title">Tunnel</div><div class="card-value" style="color:var(--green)">Active</div><div class="card-sub">'+d.tunnel+'</div></div>':''}
      ${d.cognee?'<div class="card"><div class="card-title">Cognee</div><div class="card-value" style="color:var(--green)">Connected</div><div class="card-sub">:8000</div></div>':''}
    `;
  }catch{}
}

async function loadResources() {
  document.getElementById('resources-cards').innerHTML=`
    <div class="card"><div class="card-title">Config Directory</div><div class="card-value" style="font-size:0.9rem">~/.quantumclaw/</div></div>
    <div class="card"><div class="card-title">AGEX Directory</div><div class="card-value" style="font-size:0.9rem">~/.agex/</div></div>
    <div class="card"><div class="card-title">Vector Store</div><div class="card-value" style="font-size:0.9rem">~/.quantumclaw/vectors.json</div></div>
    <div class="card"><div class="card-title">Audit Log</div><div class="card-value" style="font-size:0.9rem">~/.quantumclaw/audit.db</div></div>
  `;
}

async function loadMemory() {}

async function loadConfig() {
  try {
    // Show sanitised config (no secrets)
    const r=await api('/api/health'); const d=await r.json();
    document.getElementById('config-json').textContent=JSON.stringify(d,null,2);
  }catch(e){document.getElementById('config-json').textContent='Error: '+e.message;}
}

async function loadLogs() {
  try {
    const r=await api('/api/audit'); const d=await r.json();
    const lv=document.getElementById('log-viewer');
    if(!d.length){lv.innerHTML='<div class="log-line info">No audit entries yet.</div>';return;}
    lv.innerHTML=d.map(l=>'<div class="log-line '+(l.action==='error'?'error':l.action==='warning'?'warn':'info')+'">['+new Date(l.timestamp).toLocaleTimeString()+'] '+l.actor+' â†’ '+l.action+(l.detail?' â€” '+l.detail:'')+'</div>').join('');
    lv.scrollTop=lv.scrollHeight;
  }catch{document.getElementById('log-viewer').innerHTML='<div class="log-line error">Error loading logs</div>';}
}

async function loadDebug() {
  try {
    const r=await api('/api/health'); const d=await r.json();
    document.getElementById('debug-cards').innerHTML=`
      <div class="card"><div class="card-title">Node.js</div><div class="card-value">${navigator.userAgent.includes('Mobile')?'Mobile':'Desktop'}</div></div>
      <div class="card"><div class="card-title">WebSocket</div><div class="card-value">${ws.readyState===1?'Open':'Closed'}</div></div>
      <div class="card"><div class="card-title">Auth Token</div><div class="card-value">${TOKEN?TOKEN.slice(0,8)+'...':'None'}</div></div>
      <div class="card"><div class="card-title">Tunnel</div><div class="card-value">${d.tunnel||'None'}</div></div>
      <div class="card"><div class="card-title">Raw Health</div><div class="card-sub"><pre style="white-space:pre-wrap;font-size:0.75rem">${JSON.stringify(d,null,2)}</pre></div></div>
    `;
  }catch{}
}
</script>
</body>
</html>
